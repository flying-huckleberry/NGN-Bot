<% const pageMessage = typeof message === 'undefined' ? null : message; %>
<% const pageError = typeof error === 'undefined' ? null : error; %>
<% const safeAnnouncements = Array.isArray(announcements) ? announcements : []; %>

<div style="position:relative;">
  <%- include('../partials/flash', { message: pageMessage, error: pageError }) %>
  <h2>Auto Announcements</h2>
  <p style="color:#9ca3af;">Account: <strong style="color:#e5e7eb;"><%= account.name %></strong> <span style="margin-left:8px; color:#64748b;">(<%= account.id %>)</span></p>
  <p><a href="/accounts/<%= account.id %>/cpanel" style="color:#93c5fd; text-decoration:none;">&larr; Back to control panel</a></p>

  <div style="background:#0b1224; padding:16px; border-radius:12px; border:1px solid #1f2937; margin-top:16px;">
    <h3 style="margin-top:0; color:#cbd5e1;">Add Auto Announcement</h3>
    <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:10px;">
      Auto announcements are sent to YouTube only.
    </div>
    <form action="/accounts/<%= account.id %>/auto-announcements/save" method="post" style="display:grid; gap:12px;">
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Name
          <input name="name" type="text" placeholder="Stream reminder" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Message
          <input name="message" type="text" placeholder="Thanks for watching!" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Interval (minutes)
          <input name="intervalMinutes" type="number" min="<%= minMinutes %>" max="<%= maxMinutes %>" step="1" value="<%= minMinutes %>" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
          <span style="font-size:0.75rem; color:#94a3b8;">Between <%= minMinutes %> and <%= maxMinutes %> minutes.</span>
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Enabled
          <span style="position:relative; width:46px; height:24px; display:inline-block;">
            <input
              name="enabled"
              type="checkbox"
              value="true"
              checked
              data-announcement-toggle
              style="position:absolute; inset:0; opacity:0; width:100%; height:100%; margin:0; cursor:pointer; z-index:2;"
            />
            <span data-toggle-track style="
              position:absolute;
              inset:0;
              background:#22c55e;
              border:1px solid #334155;
              border-radius:999px;
              transition:all 0.2s ease;
              pointer-events:none;
            "></span>
            <span data-toggle-thumb style="
              position:absolute;
              top:2px;
              left:24px;
              width:20px;
              height:20px;
              background:#0b1224;
              border:1px solid #475569;
              border-radius:999px;
              box-shadow:0 1px 4px rgba(0,0,0,0.4);
              transition:all 0.2s ease;
              pointer-events:none;
            "></span>
          </span>
        </label>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button type="submit" style="background:#374D81; color:#fff; border:1px solid #4663A5; padding:8px 12px; border-radius:8px; cursor:pointer;">Create Auto Announcement</button>
        <span style="font-size:0.8rem; color:#94a3b8;">Max <%= maxEntries %> total (including disabled).</span>
      </div>
      <div style="font-size:0.85rem; color:#94a3b8;">
        Variables: <code>{channel_name}</code>, <code>{live_title}</code>, <code>{live_uptime}</code>, <code>{quota_percent}</code>, <code>{time_local}</code>, <code>{weather_temp}</code>, <code>{weather_wind_speed}</code>, <code>{weather_wind_dir}</code>, <code>{weather_precip}</code>, <code>{weather_is_day}</code>
      </div>
    </form>
  </div>

  <div style="margin-top:16px;">
    <h3 style="margin-top:0; color:#cbd5e1;">Existing Auto Announcements</h3>
    <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:8px;">
      Total: <strong style="color:#e5e7eb;"><%= safeAnnouncements.length %></strong>
      <% if (typeof maxEntries !== 'undefined') { %>
        / <strong style="color:#e5e7eb;"><%= maxEntries %></strong>
      <% } %>
    </div>
    <% if (!safeAnnouncements.length) { %>
      <p style="color:#94a3b8;">No auto announcements yet.</p>
    <% } %>
    <% safeAnnouncements.forEach((item, index) => { %>
      <div style="background:#0b1224; padding:16px; border-radius:12px; border:1px solid #1f2937; margin-bottom:12px; position:relative;">
        <div style="position:absolute; top:8px; left:8px; font-size:0.75rem; color:#94a3b8;">
          <%= index + 1 %>
        </div>
        <form action="/accounts/<%= account.id %>/auto-announcements/save" method="post" style="display:grid; gap:12px;">
          <input type="hidden" name="id" value="<%= item.id %>" />
          <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
            <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1; min-width:160px; flex:0.8 1 160px;">
              Name
              <input name="name" type="text" value="<%= item.name %>" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
            </label>
            <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1; min-width:260px; flex:2 1 260px;">
              Message
              <input name="message" type="text" value="<%= item.message %>" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
            </label>
            <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1; min-width:160px; flex:0.5 1 160px;">
              Interval (minutes)
              <input
                name="intervalMinutes"
                type="number"
                min="<%= minMinutes %>"
                max="<%= maxMinutes %>"
                step="1"
                value="<%= Math.round((Number(item.intervalSeconds || 0) / 60) || minMinutes) %>"
                style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;"
              />
            </label>
            <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
              Enabled
              <span style="position:relative; width:46px; height:24px; display:inline-block;">
                <input
                  name="enabled"
                  type="checkbox"
                  value="true"
                  <%= item.enabled ? 'checked' : '' %>
                  data-announcement-toggle
                  style="position:absolute; inset:0; opacity:0; width:100%; height:100%; margin:0; cursor:pointer; z-index:2;"
                />
                <span data-toggle-track style="
                  position:absolute;
                  inset:0;
                  background:<%= item.enabled ? '#22c55e' : '#1f2937' %>;
                  border:1px solid #334155;
                  border-radius:999px;
                  transition:all 0.2s ease;
                  pointer-events:none;
                "></span>
                <span data-toggle-thumb style="
                  position:absolute;
                  top:2px;
                  left:<%= item.enabled ? '24px' : '2px' %>;
                  width:20px;
                  height:20px;
                  background:#0b1224;
                  border:1px solid #475569;
                  border-radius:999px;
                  box-shadow:0 1px 4px rgba(0,0,0,0.4);
                  transition:all 0.2s ease;
                  pointer-events:none;
                "></span>
              </span>
            </label>
            <div style="display:flex; flex-direction:column; gap:8px; margin-left:auto; padding-bottom:2px;">
              <button type="submit" style="background:#374D81; color:#fff; border:1px solid #4663A5; padding:8px 12px; border-radius:8px; cursor:pointer;">Save</button>
              <button type="submit" formaction="/accounts/<%= account.id %>/auto-announcements/delete" formmethod="post" data-confirm="Delete this auto announcement?" style="background:#7f1d1d; color:#fff; border:1px solid #991b1b; padding:8px 12px; border-radius:8px; cursor:pointer;">Delete</button>
            </div>
          </div>
        </form>
      </div>
    <% }) %>
  </div>
</div>

<script>
  (function () {
    const main = document.querySelector('main.main');
    if (!main || main.dataset.ajaxBound === 'true') return;
    main.dataset.ajaxBound = 'true';

    const dismissFlash = () => {
      const flash = document.getElementById('cpanel-flash');
      if (flash) {
        setTimeout(() => {
          flash.style.transition = 'opacity 0.3s ease';
          flash.style.opacity = '0';
          setTimeout(() => flash.remove(), 300);
        }, 5000);
      }
      const flashError = document.getElementById('cpanel-flash-error');
      if (flashError) {
        setTimeout(() => {
          flashError.style.transition = 'opacity 0.3s ease';
          flashError.style.opacity = '0';
          setTimeout(() => flashError.remove(), 300);
        }, 5000);
      }
    };

    const renderHtml = (html) => {
      if (!main) return;
      main.innerHTML = html;
      dismissFlash();
    };

    const submitForm = async (form, submitter) => {
      const formData = new FormData(form);
      const body = new URLSearchParams();
      formData.forEach((value, key) => {
        body.append(key, value);
      });

      const action = submitter?.getAttribute('formaction') || form.action;
      const res = await fetch(action, {
        method: 'POST',
        headers: {
          Accept: 'application/json',
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        },
        body,
      });

      if (!res.ok) throw new Error('Request failed: ' + res.status);
      const data = await res.json();
      if (data?.html) renderHtml(data.html);
    };

    main.addEventListener('submit', async (event) => {
      const form = event.target;
      if (!(form instanceof HTMLFormElement)) return;
      event.preventDefault();
      const confirmMsg = event.submitter?.getAttribute('data-confirm') || form.getAttribute('data-confirm');
      if (confirmMsg && !window.confirm(confirmMsg)) return;
      try {
        await submitForm(form, event.submitter);
      } catch (err) {
        window.alert(err.message || 'Request failed');
      }
    });

    main.addEventListener('change', async (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement)) return;
      if (!target.matches('input[data-announcement-toggle]')) return;
      const wrapper = target.parentElement;
      const track = wrapper?.querySelector('[data-toggle-track]');
      const thumb = wrapper?.querySelector('[data-toggle-thumb]');
      const on = target.checked;
      if (track) track.style.background = on ? '#22c55e' : '#1f2937';
      if (thumb) thumb.style.left = on ? '24px' : '2px';

      const form = target.closest('form');
      const idInput = form?.querySelector('input[name="id"]');
      if (!form || !idInput || !idInput.value) return;

      const action = String(form.action || '').replace(/\/save(\?.*)?$/, '/toggle');
      const body = new URLSearchParams();
      body.append('id', idInput.value);
      body.append('enabled', String(on));

      try {
        target.disabled = true;
        const res = await fetch(action, {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          },
          body,
        });
        if (!res.ok) throw new Error('Request failed: ' + res.status);
        const data = await res.json();
        if (data?.html) renderHtml(data.html);
      } catch (err) {
        target.checked = !on;
        if (track) track.style.background = !on ? '#22c55e' : '#1f2937';
        if (thumb) thumb.style.left = !on ? '24px' : '2px';
        window.alert(err.message || 'Request failed');
      } finally {
        target.disabled = false;
      }
    });

    dismissFlash();
  })();
</script>
