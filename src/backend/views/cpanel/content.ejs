<% /* Account-scoped runtime + settings for transport status. */ %>
<% const liveChatId = runtime?.liveChatId || null; %>
<% const primed = Boolean(runtime?.primed); %>
<% const resolved = typeof resolvedMethod === 'string' ? resolvedMethod : null; %>
<% const target = targetInfo || {}; %>
<% const youtubeEnabled = settings?.youtube?.enabled !== false; %>
<% const discordEnabled = settings?.discord?.enabled !== false; %>
<% const youtubeOverride = resolved ? resolved.toLowerCase().includes('override') : false; %>
<% const resolvedLabel = resolved ? resolved.replace(/\s*\(override\)/i, '') : null; %>
  <% const discordState = discordStatus?.state || (discordStatus?.enabled ? 'offline' : 'disabled'); %>
  <% /* Discord status is global (client connection), while routing toggle is per account. */ %>
<% const discordConnected = discordState === 'ready'; %>
<% const disabledSet = new Set((settings?.disabledModules || []).map((name) => String(name || '').toLowerCase())); %>
<% const allowedChannelsCsv = (settings?.discord?.allowedChannelIds || []).join(','); %>
<% const timezone = settings?.timezone || ''; %>

<div id="cpanel-root" style="position:relative;">
  <%- include('../partials/flash', { message, error }) %>
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap;">
    <div>
      <h2 style="margin-bottom:6px;">Control Panel</h2>
      <p style="color:#9ca3af; margin:0 0 6px;">Account: <strong style="color:#e5e7eb;"><%= account.name %></strong> <span style="margin-left:8px; color:#64748b;">(<%= account.id %>)</span></p>
      <p style="margin:0;"><a href="/accounts" style="color:#93c5fd; text-decoration:none;">&larr; Back to accounts</a></p>
    </div>
    <% if (mode === 'dev') { %>
      <div style="min-width:260px; background:#0b1224; padding:12px; border-radius:12px; border:1px solid #1f2937;">
      <h3 style="margin:0 0 10px; color:#cbd5e1;">Dev Tools</h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <form action="/accounts/<%= account.id %>/cpanel/poll" method="post" data-cpanel-action>
            <button <%= liveChatId ? '' : 'disabled title="Connect first"' %> style="width:100%; background:#2563eb; color:#fff; border:1px solid #1d4ed8; padding:14px 12px; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer;">Poll once</button>
          </form>
          <form action="/accounts/<%= account.id %>/cpanel/reset" method="post" data-cpanel-action data-confirm="Reset runtime state for this account?">
            <button style="width:100%; background:#d9534f; color:#fff; border:1px solid #d43f3a; padding:10px 12px; border-radius:10px; cursor:pointer;">
              Reset runtime
            </button>
          </form>
          <form action="/accounts/<%= account.id %>/cpanel/connect" method="post" data-cpanel-action>
            <label style="display:block; font-size:0.85rem; margin-bottom:6px; color:#cbd5e1;">Connect via Livestream URL</label>
            <div style="display:flex; gap:8px;">
              <input name="targetLivestreamUrl" type="url" placeholder="https://www.youtube.com/watch?v=..." style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
              <button type="submit" style="background:#374D81; color:#fff; border:1px solid #4663A5; padding:8px 12px; border-radius:8px; cursor:pointer;">Send</button>
            </div>
          </form>
        </div>
      </div>
    <% } %>
  </div>

  <div class="state-status" style="margin:12px 0;">
    Runtime state:
    <span style="color:<%= stateFile === 'present' ? '#6ee7b7' : '#f87171' %>;">
      <%= stateFile === 'present' ? 'Present' : 'Missing' %>
    </span>
  </div>

  <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px;">
    <div style="flex:1; min-width:480px; background:#0b1224; color:#e5e7eb; padding:16px; border-radius:12px; border:1px solid #1f2937; box-shadow:0 8px 24px rgba(0,0,0,0.25);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0; color:#cbd5e1;">YouTube Connection</h3>
        <span style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:0.85rem; color:<%= youtubeEnabled ? (primed ? '#22c55e' : '#fbbf24') : '#f87171' %>;">
            <%= youtubeEnabled ? (primed ? 'Primed' : 'Not primed') : 'Disabled' %>
          </span>
          <span style="position:relative; width:46px; height:24px; display:inline-block;">
            <input
              type="checkbox"
              data-transport-toggle="youtube"
              <%= youtubeEnabled ? 'checked' : '' %>
              style="position:absolute; inset:0; opacity:0; width:100%; height:100%; margin:0; cursor:pointer; z-index:2;"
            />
            <span data-toggle-track style="
              position:absolute;
              inset:0;
              background:<%= youtubeEnabled ? '#22c55e' : '#1f2937' %>;
              border:1px solid #334155;
              border-radius:999px;
              transition:all 0.2s ease;
              pointer-events:none;
            "></span>
            <span data-toggle-thumb style="
              position:absolute;
              top:2px;
              left:<%= youtubeEnabled ? '24px' : '2px' %>;
              width:20px;
              height:20px;
              background:#0b1224;
              border:1px solid #475569;
              border-radius:999px;
              box-shadow:0 1px 4px rgba(0,0,0,0.4);
              transition:all 0.2s ease;
              pointer-events:none;
            "></span>
          </span>
        </span>
      </div>
      <div style="display:grid; grid-template-columns:140px 1fr; gap:6px 12px; align-items:center; font-size:0.9rem; color:#d1d5db;">
        <div style="color:#cbd5e1;">Target Method</div>
        <div>
          <% if (resolved) { %>
            <span style="color:#60a5fa">
              <%= resolvedLabel %><% if (youtubeOverride) { %> (<span style="color:#fbbf24; font-weight:600; letter-spacing:0.04em;">OVERRIDE</span>)<% } %>
            </span>
          <% } else { %>
            <span style="color:#94a3b8">Not connected</span>
          <% } %>
        </div>

        <div style="color:#cbd5e1;">LiveChat ID</div>
        <div style="display:flex; align-items:center; gap:8px;">
          <% if (!youtubeEnabled) { %>
            <span style="color:#94a3b8">Disabled</span>
          <% } else if (liveChatId) { %>
            <button type="button" data-livechat-toggle style="padding:2px 6px; border-radius:6px; border:1px solid #334155; background:#0f172a; color:#e5e7eb; cursor:pointer;">Show</button>
            <span data-livechat-value style="display:none; color:#22c55e; overflow-wrap:anywhere;"><%= liveChatId %></span>
          <% } else { %>
            <span style="color:#94a3b8">None</span>
          <% } %>
        </div>
      </div>

      <div style="margin-top:12px; display:grid; grid-template-columns:140px 1fr; gap:6px 12px; align-items:center; font-size:0.85rem; color:#94a3b8;">
        <div style="color:#cbd5e1;">Livestream Title</div>
        <div><%= target.title || 'Unavailable' %></div>

        <div style="color:#cbd5e1;">Livestream URL</div>
        <div>
          <% if (target.url) { %>
            <a href="<%= target.url %>" target="_blank" rel="noopener noreferrer" style="color:#93c5fd; text-decoration:none;"><%= target.url %></a>
            <button type="button" data-copy-url="<%= target.url %>" style="margin-left:6px; padding:2px 6px; border-radius:6px; border:1px solid #334155; background:#0f172a; color:#e5e7eb; cursor:pointer;">Copy</button>
          <% } else { %>
            <span>Unavailable</span>
          <% } %>
        </div>

        <div style="color:#cbd5e1;">Video ID</div>
        <div><%= target.videoId || 'Unavailable' %></div>

        <% if (target.channelId) { %>
          <div style="color:#cbd5e1;">Channel ID</div>
          <div><%= target.channelId %></div>
        <% } %>

        <% if (target.titleMatch) { %>
          <div style="color:#cbd5e1;">Title Match</div>
          <div>"<%= target.titleMatch %>"</div>
        <% } %>
      </div>
      <div style="margin-top:14px; padding:10px 12px; border-radius:10px; background:#0f172a; border:1px solid #1f2937;">
        <div style="font-size:0.85rem; color:#cbd5e1; margin-bottom:6px;">Title Match (optional)</div>
        <input data-youtube-title-match type="text" placeholder="Exact or partial livestream title" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
      </div>
      <% if (lastPoll) { %>
        <div style="line-height:1.6; font-size:0.9rem; margin-top:12px;">
          <strong>Last Poll:</strong> Received: <strong><%= lastPoll.received %></strong>; Handled: <strong><%= lastPoll.handled %></strong>
        </div>
      <% } %>
      <% if (quota) { %>
        <div style="margin-top:14px; padding:10px 12px; border-radius:10px; background:#0f172a; border:1px solid #1f2937;">
          <div style="font-size:0.85rem; color:#cbd5e1; margin-bottom:6px;">YouTube Quota (Est.)</div>
          <div style="font-size:0.85rem; color:#d1d5db;">
            Used: <strong><%= quota.used %></strong> / <%= quota.dailyLimit %> units (<%= quota.percentUsed %>%)
          </div>
          <div style="
            position:relative;
            width:100%;
            height:8px;
            border-radius:999px;
            background:#111827;
            overflow:hidden;
            margin:8px 0 4px;
            border:1px solid #1f2937;
          ">
            <div style="
              width:<%= quota.percentUsed %>%;
              height:100%;
              background:linear-gradient(90deg, #22c55e, #16a34a);
              transition:width 0.2s ease-out;
            "></div>
          </div>
          <div style="font-size:0.75rem; color:#9ca3af;">
            Resets at midnight Pacific. Last reset: <%= quota.lastResetPst || 'unknown' %> (PT)
          </div>
        </div>
      <% } %>
    </div>

    <div style="flex:1; min-width:480px; background:#0b1224; color:#e5e7eb; padding:16px; border-radius:12px; border:1px solid #1f2937; box-shadow:0 8px 24px rgba(0,0,0,0.25);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0; color:#cbd5e1;">Discord Connection</h3>
        <span style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:0.85rem; color:<%= discordEnabled ? '#22c55e' : '#f87171' %>;">
            <%= discordEnabled ? 'Enabled' : 'Disabled' %>
          </span>
          <span style="position:relative; width:46px; height:24px; display:inline-block;">
            <input
              type="checkbox"
              data-transport-toggle="discord"
              <%= discordEnabled ? 'checked' : '' %>
              style="position:absolute; inset:0; opacity:0; width:100%; height:100%; margin:0; cursor:pointer; z-index:2;"
            />
            <span data-toggle-track style="
              position:absolute;
              inset:0;
              background:<%= discordEnabled ? '#22c55e' : '#1f2937' %>;
              border:1px solid #334155;
              border-radius:999px;
              transition:all 0.2s ease;
              pointer-events:none;
            "></span>
            <span data-toggle-thumb style="
              position:absolute;
              top:2px;
              left:<%= discordEnabled ? '24px' : '2px' %>;
              width:20px;
              height:20px;
              background:#0b1224;
              border:1px solid #475569;
              border-radius:999px;
              box-shadow:0 1px 4px rgba(0,0,0,0.4);
              transition:all 0.2s ease;
              pointer-events:none;
            "></span>
          </span>
        </span>
      </div>
      <div style="display:grid; grid-template-columns:140px 1fr; gap:6px 12px; align-items:center; font-size:0.9rem; color:#d1d5db;">
        <div style="color:#cbd5e1;">Client Status</div>
        <div>
          <% if (discordConnected) { %>
            <span style="color:#22c55e;">Ready</span>
          <% } else { %>
            <span style="color:#fbbf24;"><%= discordState %></span>
          <% } %>
        </div>
        <% if (discordStatus?.username) { %>
          <div style="color:#cbd5e1;">Bot</div>
          <div><%= discordStatus.username %></div>
        <% } %>
        <% if (discordStatus?.readyAt) { %>
          <div style="color:#cbd5e1;">Ready at</div>
          <div><%= discordStatus.readyAt %></div>
        <% } %>
        <% if (discordStatus?.lastError) { %>
          <div style="color:#b91c1c;">Last error</div>
          <div style="color:#b91c1c;"><%= discordStatus.lastError %></div>
        <% } %>
      </div>
    </div>
  </div>

  <% if (modules && modules.length) { %>
    <div style="background:#0b1224; padding:12px; border-radius:10px; border:1px solid #1f2937; margin-bottom:16px;">
      <h3 style="margin-top:0; color:#cbd5e1;">Module Toggles</h3>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
        <% modules.forEach((name) => { %>
          <% const enabled = !disabledSet.has(String(name || '').toLowerCase()); %>
          <div data-module-toggle-wrapper data-module-card style="position:relative; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; background:#0f172a; border:1px solid #1f2937; color:#e5e7eb; transition:background 0.2s ease;">
            <a href="/accounts/<%= account.id %>/modules/<%= encodeURIComponent(String(name || '').toLowerCase()) %>" aria-label="Edit <%= name %> module settings" style="position:absolute; inset:0; border-radius:8px; z-index:1; cursor:pointer;"></a>
            <span data-module-link-text style="font-size:0.95rem;"><%= name %> &rarr;</span>
            <span data-module-toggle-hit style="position:relative; width:46px; height:24px; display:inline-block; z-index:2; cursor:pointer;">
              <input
                type="checkbox"
                data-module-toggle="<%= name %>"
                <%= enabled ? 'checked' : '' %>
                style="position:absolute; opacity:0; width:100%; height:100%; margin:0; cursor:pointer;"
              />
              <span data-toggle-track style="
                position:absolute;
                inset:0;
                background:<%= enabled ? '#22c55e' : '#1f2937' %>;
                border:1px solid #334155;
                border-radius:999px;
                transition:all 0.2s ease;
              "></span>
              <span data-toggle-thumb style="
                position:absolute;
                top:2px;
                left:<%= enabled ? '24px' : '2px' %>;
                width:20px;
                height:20px;
                background:#0b1224;
                border:1px solid #475569;
                border-radius:999px;
                box-shadow:0 1px 4px rgba(0,0,0,0.4);
                transition:all 0.2s ease;
              "></span>
            </span>
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>

  <div data-announcements-card style="background:#0b1224; padding:12px; border-radius:10px; border:1px solid #1f2937; margin-bottom:16px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h3 style="margin:0; color:#cbd5e1;">
        <a href="/accounts/<%= account.id %>/auto-announcements" onmouseover="this.style.textDecoration='underline';" onmouseout="this.style.textDecoration='none';" style="color:#cbd5e1; text-decoration:none;">Auto Announcements &rarr;</a>
      </h3>
      <span style="font-size:0.85rem; color:#94a3b8;">
        <%= (autoAnnouncements && autoAnnouncements.length) ? `${autoAnnouncements.length} total` : 'None configured' %>
      </span>
    </div>
  </div>

  <div data-commands-accordion style="background:#0b1224; padding:12px; border-radius:10px; border:1px solid #1f2937; margin-bottom:16px; transition:background 0.2s ease;">
    <div data-commands-header style="display:flex; align-items:center; justify-content:space-between; gap:12px; cursor:pointer;">
      <h3 style="margin:0; color:#cbd5e1;">
        <a href="/accounts/<%= account.id %>/commands" onmouseover="this.style.textDecoration='underline';" onmouseout="this.style.textDecoration='none';" style="color:#cbd5e1; text-decoration:none;">Custom Commands &rarr;</a>
      </h3>
      <button type="button" data-commands-toggle style="background:#111827; color:#e5e7eb; border:1px solid #1f2937; padding:4px 10px; border-radius:6px; cursor:pointer;">Show</button>
    </div>
    <div data-commands-body style="display:none; margin-top:12px;">
      <% if (customCommands && customCommands.length) { %>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          <% customCommands.forEach((cmd) => { %>
            <span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #1f2937; background:<%= cmd.enabled ? '#0f172a' : '#111827' %>; color:<%= cmd.enabled ? '#e5e7eb' : '#94a3b8' %>;">
              <%= cmd.name %>
              <span style="font-size:0.7rem; color:#64748b;"><%= cmd.platform || 'both' %></span>
            </span>
          <% }) %>
        </div>
      <% } else { %>
        <p style="color:#94a3b8; margin:0;">No custom commands yet.</p>
      <% } %>
    </div>
  </div>

  <div style="background:#0b1224; padding:16px; border-radius:12px; border:1px solid #1f2937; margin-bottom:16px;">
    <h3 style="margin-top:0; color:#cbd5e1;">Account Details</h3>
    <form action="/accounts/<%= account.id %>" method="post" data-cpanel-action style="display:grid; gap:12px;">
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Account Name
          <input name="name" type="text" value="<%= account.name %>" required style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          YouTube Channel ID
          <input name="youtubeChannelId" type="text" value="<%= account.youtube?.channelId || '' %>" placeholder="UCxxxxxxxxxxxx" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Discord Guild ID
          <input name="discordGuildId" type="text" value="<%= account.discord?.guildId || '' %>" placeholder="1234567890" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Allowed Channel IDs
          <input name="discordAllowedChannelIds" type="text" value="<%= allowedChannelsCsv %>" placeholder="123,456" style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
          <span style="font-size:0.75rem; color:#94a3b8;">CSV; leave blank to allow all channels.</span>
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Command Prefix
          <input name="commandPrefix" type="text" maxlength="1" value="<%= settings?.commandPrefix || '!' %>" style="padding:8px 10px; width:60px; text-align:center; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;" />
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; color:#cbd5e1;">
          Timezone
          <select name="timezone" data-timezone-select style="padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e5e7eb;">
            <option value="">Use server timezone</option>
            <% if (timezone) { %>
              <option value="<%= timezone %>" selected><%= timezone %></option>
            <% } %>
          </select>
        </label>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button type="submit" style="background:#374D81; color:#fff; border:1px solid #4663A5; padding:8px 12px; border-radius:8px; cursor:pointer;">Save Settings</button>
      </div>
    </form>
    <form action="/accounts/<%= account.id %>/delete" method="post" onsubmit="return confirm('Delete this account and all associated state?');" style="margin-top:12px;">
      <button type="submit" style="background:#7f1d1d; color:#fff; border:1px solid #991b1b; padding:8px 12px; border-radius:8px; cursor:pointer;">Delete Account</button>
    </form>
  </div>
</div>

<script>
  (function () {
    const attachHandlers = () => {
      const root = document.getElementById('cpanel-root');
      if (!root) return;

      const initTimezoneSelect = () => {
        // Build a searchable timezone selector from Intl.supportedValuesOf.
        const select = root.querySelector('select[data-timezone-select]');
        if (!select || select.dataset.tomSelect === 'true') return;

        const zones = typeof Intl.supportedValuesOf === 'function'
          ? Intl.supportedValuesOf('timeZone')
          : [];
        const fallback = [
          'UTC',
          'America/New_York',
          'America/Chicago',
          'America/Denver',
          'America/Los_Angeles',
          'Europe/London',
          'Europe/Paris',
          'Asia/Tokyo',
        ];
        const list = zones.length ? zones : fallback;

        // Keep any previously saved timezone even if it isn't in the runtime list.
        const current = select.value;
        select.innerHTML = '';

        if (!current) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '';
          opt.selected = true;
          select.appendChild(opt);
        }

        list.forEach((zone) => {
          const opt = document.createElement('option');
          opt.value = zone;
          opt.textContent = zone;
          if (zone === current) opt.selected = true;
          select.appendChild(opt);
        });

        if (current && !list.includes(current)) {
          const opt = document.createElement('option');
          opt.value = current;
          opt.textContent = current;
          opt.selected = true;
          select.appendChild(opt);
        }

        const applyTomSelect = () => {
          // Tom Select enhances the native select with search + styling.
          if (!window.TomSelect) return false;
          // eslint-disable-next-line no-new
          new TomSelect(select, {
            create: false,
            allowEmptyOption: true,
            searchField: ['text'],
            sortField: { field: 'text', direction: 'asc' },
            placeholder: 'Search timezone...',
            maxItems: 1,
          });
          select.dataset.tomSelect = 'true';
          return true;
        };

        if (!applyTomSelect()) {
          setTimeout(() => {
            applyTomSelect();
          }, 100);
        }
      };

      const flash = document.getElementById('cpanel-flash');
      if (flash) {
        setTimeout(() => {
          flash.style.transition = 'opacity 0.3s ease';
          flash.style.opacity = '0';
          setTimeout(() => flash.remove(), 300);
        }, 5000);
      }
      const flashError = document.getElementById('cpanel-flash-error');
      if (flashError) {
        setTimeout(() => {
          flashError.style.transition = 'opacity 0.3s ease';
          flashError.style.opacity = '0';
          setTimeout(() => flashError.remove(), 300);
        }, 5000);
      }

      const bindModuleToggles = () => {
        root.querySelectorAll('input[data-module-toggle]').forEach((input) => {
          input.addEventListener('change', async (event) => {
            const target = event.currentTarget;
            const moduleName = target.dataset.moduleToggle;
            if (!moduleName) return;
            const desired = target.checked;
            const previous = !desired;
            const wrapper = target.closest('[data-module-toggle-wrapper]');
            const track = wrapper?.querySelector('[data-toggle-track]');
            const thumb = wrapper?.querySelector('[data-toggle-thumb]');
            const applyVisual = (on) => {
              if (track) {
                track.style.background = on ? '#22c55e' : '#1f2937';
              }
              if (thumb) {
                thumb.style.left = on ? '24px' : '2px';
              }
            };

            applyVisual(desired);

            const body = new URLSearchParams();
            body.append('module', moduleName);
            body.append('enabled', String(desired));

            target.disabled = true;
            try {
              const res = await fetch(`/accounts/<%= account.id %>/cpanel/modules`, {
                method: 'POST',
                headers: {
                  Accept: 'application/json',
                  'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                },
                body,
              });
              if (!res.ok) throw new Error('Request failed: ' + res.status);
              const data = await res.json();
              if (data?.html) {
                const placeholder = document.createElement('div');
                placeholder.innerHTML = data.html;
                const nextRoot = placeholder.querySelector('#cpanel-root');
                if (nextRoot && root.parentNode) {
                  root.parentNode.replaceChild(nextRoot, root);
                  attachHandlers();
                }
              }
            } catch (err) {
              console.error(err);
              target.checked = previous;
              applyVisual(previous);
              window.alert(err.message || 'Request failed');
            } finally {
              target.disabled = false;
            }
          });
        });
      };

      const bindModuleCardHover = () => {
        root.querySelectorAll('[data-module-card]').forEach((card) => {
          if (card.dataset.bound === 'true') return;
          card.dataset.bound = 'true';
          const hoverColor = '#1b2c4d';
          const baseColor = '#0f172a';
          const toggleHit = card.querySelector('[data-module-toggle-hit]');
          const linkText = card.querySelector('[data-module-link-text]');

          const isOverToggle = (target) => toggleHit && toggleHit.contains(target);
          const applyHover = (on) => {
            card.style.background = on ? hoverColor : baseColor;
            if (linkText) {
              linkText.style.textDecoration = on ? 'underline' : 'none';
            }
          };

          card.addEventListener('mouseenter', (event) => {
            if (!isOverToggle(event.target)) applyHover(true);
          });
          card.addEventListener('mousemove', (event) => {
            applyHover(!isOverToggle(event.target));
          });
          card.addEventListener('mouseleave', () => {
            applyHover(false);
          });
        });
      };

      const bindTransportToggles = () => {
        root.querySelectorAll('input[data-transport-toggle]').forEach((input) => {
          input.addEventListener('change', async (event) => {
            const target = event.currentTarget;
            const transport = target.dataset.transportToggle;
            if (!transport) return;
            const desired = target.checked;
            const previous = !desired;
            const wrapper = target.parentElement;
            const track = wrapper?.querySelector('[data-toggle-track]');
            const thumb = wrapper?.querySelector('[data-toggle-thumb]');
            const applyVisual = (on) => {
              if (track) {
                track.style.background = on ? '#22c55e' : '#1f2937';
              }
              if (thumb) {
                thumb.style.left = on ? '24px' : '2px';
              }
            };

            applyVisual(desired);

            const body = new URLSearchParams();
            body.append('transport', transport);
            body.append('enabled', String(desired));
            if (transport === 'youtube') {
              const titleInput = root.querySelector('[data-youtube-title-match]');
              const titleMatch = String(titleInput?.value || '').trim();
              if (titleMatch) {
                body.append('youtubeTitleMatch', titleMatch);
              }
            }

            target.disabled = true;
            try {
              const res = await fetch(`/accounts/<%= account.id %>/cpanel/transports`, {
                method: 'POST',
                headers: {
                  Accept: 'application/json',
                  'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                },
                body,
              });
              if (!res.ok) throw new Error('Request failed: ' + res.status);
              const data = await res.json();
              if (data?.html) {
                const placeholder = document.createElement('div');
                placeholder.innerHTML = data.html;
                const nextRoot = placeholder.querySelector('#cpanel-root');
                if (nextRoot && root.parentNode) {
                  root.parentNode.replaceChild(nextRoot, root);
                  attachHandlers();
                }
              }
            } catch (err) {
              console.error(err);
              target.checked = previous;
              applyVisual(previous);
              window.alert(err.message || 'Request failed');
            } finally {
              target.disabled = false;
            }
          });
        });
      };

      const bindCopyButtons = () => {
        root.querySelectorAll('button[data-copy-url]').forEach((btn) => {
          if (btn.dataset.bound === 'true') return;
          btn.dataset.bound = 'true';
          btn.addEventListener('click', async () => {
            const url = btn.dataset.copyUrl || '';
            if (!url) return;
            try {
              if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(url);
              } else {
                const field = document.createElement('textarea');
                field.value = url;
                field.setAttribute('readonly', '');
                field.style.position = 'absolute';
                field.style.left = '-9999px';
                document.body.appendChild(field);
                field.select();
                document.execCommand('copy');
                document.body.removeChild(field);
              }
              const original = btn.textContent;
              btn.textContent = 'Copied';
              setTimeout(() => {
                btn.textContent = original;
              }, 1200);
            } catch (err) {
              console.error(err);
              window.alert('Failed to copy URL.');
            }
          });
        });
      };

      const bindLiveChatToggle = () => {
        root.querySelectorAll('button[data-livechat-toggle]').forEach((btn) => {
          if (btn.dataset.bound === 'true') return;
          btn.dataset.bound = 'true';
          btn.addEventListener('click', () => {
            const value = btn.parentElement?.querySelector('[data-livechat-value]');
            if (!value) return;
            const isHidden = value.style.display === 'none';
            value.style.display = isHidden ? 'inline' : 'none';
            btn.textContent = isHidden ? 'Hide' : 'Show';
          });
        });
      };

      const bindCommandsAccordion = () => {
        const accordion = root.querySelector('[data-commands-accordion]');
        if (!accordion || accordion.dataset.bound === 'true') return;
        accordion.dataset.bound = 'true';
        const header = accordion.querySelector('[data-commands-header]');
        const body = accordion.querySelector('[data-commands-body]');
        const button = accordion.querySelector('[data-commands-toggle]');
        if (!header || !body || !button) return;

        const hoverColor = '#1b2c4d';
        const baseColor = '#0b1224';

        accordion.addEventListener('mouseenter', () => {
          accordion.style.background = hoverColor;
        });
        accordion.addEventListener('mouseleave', () => {
          accordion.style.background = baseColor;
        });

        const toggle = () => {
          const isHidden = body.style.display === 'none';
          body.style.display = isHidden ? 'block' : 'none';
          button.textContent = isHidden ? 'Hide' : 'Show';
        };

        header.addEventListener('click', (event) => {
          if (event.target && event.target.closest('a')) {
            return;
          }
          toggle();
        });
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          toggle();
        });
      };

      const setLoading = (isLoading) => {
        root.querySelectorAll('button').forEach((btn) => {
          const alreadyDisabled = btn.dataset.originalDisabled === 'true';
          if (isLoading) {
            btn.dataset.originalDisabled = btn.hasAttribute('disabled') ? 'true' : 'false';
            btn.disabled = true;
            if (!btn.dataset.originalText) btn.dataset.originalText = btn.textContent;
            btn.textContent = 'Working...';
          } else {
            if (!alreadyDisabled) btn.disabled = false;
            if (btn.dataset.originalText) {
              btn.textContent = btn.dataset.originalText;
              delete btn.dataset.originalText;
            }
          }
        });
      };

      root.querySelectorAll('form[data-cpanel-action]').forEach((form) => {
        form.addEventListener(
          'submit',
          async (event) => {
            event.preventDefault();
            const confirmMsg = form.dataset.confirm;
            if (confirmMsg && !window.confirm(confirmMsg)) return;

            const formData = new FormData(form);
            const body = new URLSearchParams();
            formData.forEach((value, key) => {
              body.append(key, value);
            });

            setLoading(true);
            try {
              const res = await fetch(form.action, {
                method: 'POST',
                headers: {
                  Accept: 'application/json',
                  'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                },
                body,
              });
              if (!res.ok) throw new Error('Request failed: ' + res.status);
              const data = await res.json();
              if (data?.redirect) {
                window.location.href = data.redirect;
                return;
              }
              if (data?.html) {
                const placeholder = document.createElement('div');
                placeholder.innerHTML = data.html;
                const nextRoot = placeholder.querySelector('#cpanel-root');
                if (nextRoot && root.parentNode) {
                  root.parentNode.replaceChild(nextRoot, root);
                  attachHandlers();
                }
              }
            } catch (err) {
              console.error(err);
              window.alert(err.message || 'Request failed');
            } finally {
              setLoading(false);
            }
          },
          { once: true }
        );
      });

      bindModuleToggles();
      bindTransportToggles();
      bindCopyButtons();
      bindModuleCardHover();
      bindLiveChatToggle();
      bindCommandsAccordion();
      initTimezoneSelect();
    };

    attachHandlers();
  })();
</script>
